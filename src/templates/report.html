<!doctype html>
<html>

<head>
    <title>Mission checker report</title>

    <style>
        /* based on https://thebestmotherfucking.website/css/main.css */

        * {
            box-sizing: border-box;
        }

        *:empty {
            display: none;
        }

        html {
          background-color: #fefefe
          min-width: 1350px;
        }

        body {
          /* font-family: Open Sans,Arial; */
          font-family: sans;
          color: #454545;
          /* font-size: 16px; */
          font-size: 20px;
          margin: 2em auto;
          min-width: 800px;
          max-width: 100%;
          padding: 1em;
          /* line-height: 1.4; */
          line-height: 1.8;
          text-align: justify
        }

        html.contrast body {
          color: #050505
        }

        html.contrast blockquote {
          color: #11151a
        }

        html.contrast blockquote:before {
          color: #262626
        }

        html.contrast a {
          color: #0051c9
        }

        html.contrast a:visited {
          color: #7d013e
        }

        html.contrast span.wr {
          color: #800
        }

        html.contrast span.mfw {
          color: #4d0000
        }

        html.inverted {
          background-color: #010101
        }

        html.inverted body {
          color: #bababa
        }

        html.inverted div#invmode {
          color: #fff;
          background-color: #000
        }

        html.inverted blockquote {
          color: #dad0c7
        }

        html.inverted blockquote:before {
          color: #bfbfbf
        }

        html.inverted a {
          color: #07a
        }

        html.inverted a:visited {
          color: #ac5a82
        }

        html.inverted span.wr {
          color: #c0392b
        }

        html.inverted span.mfw {
          color: #8a0000
        }

        a {
          color: #07a
        }

        a:visited {
          color: #941352
        }

        .noselect {
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none
        }

        span.citneed {
          vertical-align: top;
          font-size: .7em;
          padding-left: .3em
        }

        small {
          font-size: .4em
        }

        p.st {
          margin-top: -1em
        }

        div.fancyPositioning div.picture-left {
          float: left;
          width: 40%;
          overflow: hidden;
          margin-right: 1em
        }

        div.fancyPositioning div.picture-left img {
          width: 100%
        }

        div.fancyPositioning div.picture-left p.caption {
          font-size: .7em
        }

        div.fancyPositioning div.tleft {
          float: left;
          width: 55%
        }

        div.fancyPositioning div.tleft p:first-child {
          margin-top: 0
        }

        div.fancyPositioning:after {
          display: block;
          content: "";
          clear: both
        }

        ul li img {
          height: 1em
        }

        blockquote {
          color: #456;
          margin-left: 0;
          margin-top: 2em;
          margin-bottom: 2em
        }

        blockquote span {
          float: left;
          margin-left: 1rem;
          padding-top: 1rem
        }

        blockquote author {
          display: block;
          clear: both;
          font-size: .6em;
          margin-left: 2.4rem;
          font-style: oblique
        }

        blockquote author:before {
          content: "- ";
          margin-right: 1em
        }

        blockquote:before {
          font-family: Times New Roman,Times,Arial;
          color: #666;
          content: open-quote;
          font-size: 2.2em;
          font-weight: 600;
          float: left;
          margin-top: 0;
          margin-right: .2rem;
          width: 1.2rem
        }

        blockquote:after {
          content: "";
          display: block;
          clear: both
        }

        @media screen and (max-width: 500px) {
          body {
            text-align:left
          }

          div.fancyPositioning div.picture-left,div.fancyPositioning div.tleft {
            float: none;
            width: inherit
          }

          blockquote span {
            width: 80%
          }

          blockquote author {
            padding-top: 1em;
            width: 80%;
            margin-left: 15%
          }

          blockquote author:before {
            content: "";
            margin-right: inherit
          }
        }

        span.visited {
          color: #941352
        }

        span.visited-maroon {
          color: #85144b
        }

        span.wr {
          color: #c0392b;
          font-weight: 600;
          text-decoration: underline
        }

        div#contrast {
          color: #000;
          top: 10px
        }

        div#contrast,div#invmode {
          cursor: pointer;
          position: absolute;
          right: 10px;
          font-size: .8em;
          text-decoration: underline;
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none
        }

        div#invmode {
          color: #fff;
          background-color: #000;
          top: 34px;
          padding: 2px 5px
        }

        span.sb {
          color: #00e
        }

        span.sb,span.sv {
          cursor: not-allowed
        }

        span.sv {
          color: #551a8b
        }

        span.foufoufou {
          color: #444;
          font-weight: 700
        }

        span.foufoufou:before {
          content: "";
          display: inline-block;
          width: 1em;
          height: 1em;
          margin-left: .2em;
          margin-right: .2em;
          background-color: #444
        }

        span.foufivfoufivfoufiv {
          color: #454545;
          font-weight: 700
        }

        span.foufivfoufivfoufiv:before {
          content: "";
          display: inline-block;
          width: 1em;
          height: 1em;
          margin-left: .2em;
          margin-right: .2em;
          background-color: #454545
        }

        span.mfw {
          color: #730000
        }

        a.kopimi,a.kopimi img.kopimi {
          display: block;
          margin-left: auto;
          margin-right: auto
        }

        a.kopimi img.kopimi {
          height: 2em
        }

        p.fakepre {
          font-family: monospace;
          font-size: .9em
        }

        .squad-unit {
            display: flex;
        }

        .squad-unit div {
            padding-right: 1em;
        }

        .squad-unit div:last-child {
            padding: 0;
        }

        .warning {
            color: #b74c00;
        }

        .error {
            color: #bb0a1e;
        }

        .squadTitle {
            text-decoration: underline;
        }

        .unitType {
            min-width: 10em;
            max-width: 14em;
        }

        main {
            display: flex;
            flex-direction: column;
        }

        main > * {
            margin-top: 1.5em;

            /*
            :first-child {
                margin-top: 0;
            }
            */
        }

        .top {
            display: flex;
            flex-direction: row;
        }

        /*
        .top > * {
            margin-top: 1.5em;

            :first-child {
                margin-top: 0;
            }
        }
        */

        .flex-child {
            background-color: #ffaaaf;
        }

        .half-parent-width {
            width: 50%;
        }

        .gigantic-list {
            
        }

        .list-item {
            width: 100%;
            display: flex;
            flex-direction: column;
            margin-top: 1em;
        }

        .list-item > :first-child {
            display: flex;
            flex-direction: row;
        }

        .list-item > :first-child > * {
            margin-right: 2em;
        }

        .uniq-unit-inits .init {
            display: block;
        }

        .side-container {
            margin-top: 2em;
        }
    </style>

</head>
<body>
    <header>
        <!-- <label for="lang">Choose language:</label> -->

        <select id="lang">
            <option value="ru">Russian</option>
            <option value="en">English</option>
        </select>
    </header>
    <script>
        'use strict';

        {% include 'localizations' %}


        const localize = (str, to_substitute) =>
            str.replace(
                // /${.*?}/g,        // more strict?
                /{.*?}/g,         // matches with brackets
                // /(?:{).*?(?:})/g, // unfortunately capture brackets too
                //(k) => to_substitute[k]
                (k) => to_substitute[k.split('{')[1].split('}')[0]]
            );

        const report_json = {{ json | safe }};

        // TODO: remove this line
        console.log(JSON.parse(report_json));

        const report = JSON.parse(
            report_json.replace(/</g, '&lt\;').replace(/>/g, '&gt\;').replace(/\\"\\"/g, '\\"')
        );

        if (report.diff) console.log('nope');


        const langSelect = document.getElementById('lang');

        const renderWithLang = (lang) => {

            langSelect.value = lang;


            const oldMain = document.getElementsByTagName('main')[0];

            if (oldMain) {

                oldMain.remove();

            }


            const main = document.getElementsByTagName('body')[0].appendChild(document.createElement('main'));

            // read localStorage. use russian if empty/no localStorage (incognito ff?)
            const msg = localizations[lang];

            const emptyDiv = document.createElement('div');

            const emptyCode = document.createElement('code');


            const addDiv = (text) => main.appendChild(
                emptyDiv.cloneNode()
            ).innerHTML = text;

            const appendEmptyTo = (parentNode) => parentNode.appendChild(emptyDiv.cloneNode());

            const addClassyEl = (el, parentNode, classesString) => {
                
                const clone = el.cloneNode();

                if (classesString) {

                    clone.classList.add(...classesString.split(' '));

                }

                return parentNode.appendChild(clone);
            };

            const addClassyDiv = (parentNode, classesString) => addClassyEl(emptyDiv, parentNode, classesString);

            const addClassyCode = (parentNode, classesString) => addClassyEl(emptyCode, parentNode, classesString);

            const addWarning = (parentNode, text) => {
                addClassyDiv(parentNode, 'warning').innerHTML = text;
            };

            const addError = (parentNode, text) => {
                addClassyDiv(parentNode, 'error').innerHTML = text;
            };

            if (report.errors) {
            
                if (report.errors.wrong_filename) {

                    addError(main, msg.errors.wrong_filename);

                    return;

                } else if (report.errors.extraction_error) {
                
                    addError(main, msg.errors.extraction_error);

                    return;

                }

            }

            //console.log(msg.errors, Object.keys(report.errors))


            if (report.mission_attrs) {

                const topDiv = addClassyDiv(main, 'flex-child top mission-attrs__warnings__wmt');

                const attrsDiv = addClassyDiv(topDiv, 'flex-child half-parent-width');

                const mission_attrs_in_order = [
                    'briefing_name',
                    'overview_text',
                    'author',
                    'loadScreen',
                ];

                mission_attrs_in_order.forEach(
                    attr_name => {
                        const attribute_value = report.mission_attrs && report.mission_attrs[attr_name]

                        console.log(attr_name, attribute_value);

                        if (attribute_value) {
                            addClassyDiv(attrsDiv)
                                .innerHTML = `${msg.mission_attrs[attr_name]}: ${attribute_value}`;
                        }
                    }
                );


                const mission_attrs_warnings = [
                    'wrong_briefing_name',
                    'saving',
                    'respawn',
                    'respawn_rulesets',
                    'enable_target_debugging',
                    'wrong_wind',
                    'wrong_rain',
                ];

                mission_attrs_warnings.forEach(
                    attr_name => {
                        const attribute_value = report.mission_attrs && report.mission_attrs[attr_name]

                        console.log(attr_name, attribute_value);

                        if (attribute_value) {
                            //console.log(attr_name, msg.errors[attr_name]);

                            addError(attrsDiv, msg.errors[attr_name]);
                        }
                    }
                );


                const binaryAttrs = addClassyDiv(topDiv, 'flex-child wmt__other_binary_attrs');

                // REFACTOR
                addClassyDiv(binaryAttrs, 'flex-child')
                    .innerHTML = (
                        msg.mission_attrs['wog3_no_auto_long_range_radio'] +
                        ': ' +
                        (report.mission_attrs['wog3_no_auto_long_range_radio'] ? '-' : '+')
                    );


                addClassyDiv(binaryAttrs, 'flex-child')
                    .innerHTML = (
                        msg.mission_attrs['wmt_auto_med_provision'] +
                        ': ' +
                        (report.mission_attrs['wmt_auto_med_provision'] ? '+' : '-')
                    );

                addClassyDiv(binaryAttrs, 'flex-child')
                    .innerHTML = (
                        msg.mission_attrs['wmt_side_channel_by_lr'] +
                        ': ' +
                        (report.mission_attrs['wmt_side_channel_by_lr'] ? '+' : '-')
                    );

                addClassyDiv(binaryAttrs, 'flex-child')
                    .innerHTML = (
                        msg.mission_attrs['wmt_disable_fuel_stations'] +
                        ': ' +
                        (report.mission_attrs['wmt_disable_fuel_stations'] ? '-' : '+')
                    );

            }


            const errorsDiv = addClassyDiv(main, 'flex-child errors');

            if (report.warnings.has_description_ext) {

                addWarning(errorsDiv, msg.warnings.has_description_ext);

            }


            Object.keys(report.errors).forEach(
                error => {

                    console.log(error, msg.errors[error])

                    if (msg.errors[error]) {

                        if (error === 'vanilla_equipment') {

                            addError(errorsDiv, msg.errors[error] + report.errors[error].join(', '));

                        // filtering errors that we show in different places
                        } else if (error !== 'has_unit_with_backpack_dup' && error !== 'unsupported_equipment_init') {

                            if (report.errors[error] !== true) {

                                addError(errorsDiv, msg.errors[error] + ' ' + report.errors[error]);

                            } else {
                            
                                addError(errorsDiv, msg.errors[error]);

                            }

                        }

                    } else {
                        
                        throw 'unlocalized error';
                    }
                }
            );


            const playable_slots_count = Object.keys(report.slots.playable_slots)
                .reduce((acc, side) => acc + report.slots.playable_slots[side], 0);

            if (playable_slots_count > 190) {
                
                addError(errorsDiv, msg.errors.too_many_slots);

            }


            if ((report.vehicles && report.vehicles.length) ||
                report.boxes && report.boxes.length) {

                const vehiclesStaticBoxesDiv = addClassyDiv(main, 'flex-child vehicles__static__boxes');

                addClassyDiv(vehiclesStaticBoxesDiv, 'flex-child heading')
                    .innerHTML = msg.headings.vehicles_static_boxes;

                const vehiclesStaticBoxesListDiv = addClassyDiv(vehiclesStaticBoxesDiv, 'flex-child gigantic-list');

                report.vehicles.forEach(
                    ({name, type, description, init, lock, fuel, ammo, health, ace_isMedicalVehicle,
                        ace_isRepairVehicle}) => {

                        const listItem = addClassyDiv(vehiclesStaticBoxesListDiv, 'flex-child list-item');
                        
                        const listItemFirstRow = addClassyDiv(listItem, 'flex-child first-row');

                        addClassyDiv(listItemFirstRow, 'flex-child')
                            .innerHTML = `${name} (${type}) ${description || ''}`;

                        addClassyDiv(listItemFirstRow, 'flex-child')
                            .innerHTML = lock || '';

                        if (typeof fuel === 'number') {

                            addClassyDiv(listItemFirstRow, 'flex-child')
                                .innerHTML = `${msg.vehicles.fuel} ${fuel}%`;
                        }

                        if (typeof ammo === 'number') {

                            addClassyDiv(listItemFirstRow, 'flex-child')
                                .innerHTML = `${msg.vehicles.ammo} ${ammo}%`;

                        }

                        if (typeof health === 'number') {

                            addClassyDiv(listItemFirstRow, 'flex-child')
                                .innerHTML = `&#10084; ${health}%`;
                        }

                        if (ace_isMedicalVehicle == '1.0') {

                            addClassyDiv(listItemFirstRow, 'flex-child')
                                .innerHTML = msg.vehicles.ace_isMedicalVehicle;
                        }

                        if (ace_isRepairVehicle == '1.0') {

                            addClassyDiv(listItemFirstRow, 'flex-child')
                                .innerHTML = msg.vehicles.ace_isRepairVehicle;

                        }


                        if (init) {

                            addClassyCode(listItem, 'flex-child second-row')
                                .innerHTML = init;

                        }
                    }
                );

                report.boxes.forEach(
                    ({name, type, description, init}) => {

                        const listItem = addClassyDiv(vehiclesStaticBoxesListDiv, 'flex-child list-item');
                        
                        const listItemFirstRow = addClassyDiv(listItem, 'flex-child first-row');

                        addClassyDiv(listItemFirstRow, 'flex-child')
                            .innerHTML = `${name} (${type}) ${description || ''}`;


                        if (init) {

                            addClassyCode(listItem, 'flex-child second-row')
                                .innerHTML = init;

                        }
                    }
                );
            }


            if (report.sides) {

                const isMedic = (attr_value) => {

                    // any other value counts as "Default" in UI; medic unit will be medic
                    if (attr_value === '0.0' || attr_value === '1.0' || attr_value === '2.0') {

                        return msg.slots.ace_isMedic[attr_value];

                    }
                };

                const isEngineer = (attr_value) => {
                
                    if (attr_value === '0.0' || attr_value === '1.0' || attr_value === '2.0') {
                
                        return msg.slots.ace_isEngineer[attr_value];

                    } else if (typeof attr_value !== 'undefined') {
                        
                        return msg.slots.ace_isEngineer.unusual_value + attr_value;

                    }
                };

                const unitsDiv = addClassyDiv(main, 'flex-child units');

                addClassyDiv(unitsDiv, 'flex-child heading')
                    .innerHTML = msg.headings.units;

                const uniq_init_map = report.slots.unique_inits.reduce(
                    
                    (acc, {init}, i) => {
                        
                        acc[init] = i;

                        return acc;
                    },
                    {}
                );

                Object.keys(report.sides).forEach(

                    (side) => {

                        const sideUnitsContainer = addClassyDiv(unitsDiv, 'flex-child side-container');

                        //addClassyDiv(sideUnitsContainer, 'flex-child')
                        //    .innerHTML = msg.slots.side_playable_slots_count;

                        addClassyDiv(sideUnitsContainer, 'flex-child side-name__slots_count')
                            .innerHTML = localize(
                                msg.slots.side_playable_slots_count,
                                {side, playable_slots: report.slots.playable_slots[side]}
                            );

                        report.sides[side].forEach(
                            ({units, groupID}, i) => {

                                const squad = addClassyDiv(sideUnitsContainer, 'flex-child squad');

                                const squadName = addClassyDiv(squad, 'flex-child list-item squad-name')
                                    .innerHTML = `\n${groupID || (msg.slots.squad_default_name + (i + 1))}\n`;

                                const squadUnits = addClassyDiv(squad, 'flex-child squad-units');

                                units.forEach(
                                    // unit_name?
                                    ({isPlayable, init, has_inventory, type, description, ace_isEngineer,
                                        ace_isMedic}) => {

                                        const unit = addClassyDiv(squadUnits, 'flex-child squad-unit list-item');

                                        const typeAndDescriptionDiv = addClassyDiv(
                                            unit,
                                            'flex-child type__description'
                                        );

                                        addClassyDiv(
                                            typeAndDescriptionDiv,
                                            'flex-child type'
                                        ).innerHTML = type;

                                        if (description) {

                                            addClassyDiv(
                                                typeAndDescriptionDiv,
                                                'flex-child description'
                                            ).innerHTML = description;

                                        }

                                        if (init) {

                                            addClassyDiv(
                                                typeAndDescriptionDiv,
                                                'flex-child link-to-init'
                                            ).innerHTML = `<a href="#n${uniq_init_map[init]}">go to eq init</a>`;

                                        }

                                        if (ace_isEngineer || ace_isMedic) {

                                            const skillsDiv = addClassyDiv(
                                                unit,
                                                'flex-child skills'
                                            );

                                            if (ace_isEngineer) {

                                                addClassyDiv(
                                                    skillsDiv,
                                                    'flex-child isEngineer'
                                                ).innerHTML = isEngineer(ace_isEngineer);

                                            }

                                            if (ace_isMedic) {

                                                addClassyDiv(
                                                    skillsDiv,
                                                    'flex-child isMedic'
                                                ).innerHTML = isMedic(ace_isMedic);

                                            }
                                        }

                                        if (!isPlayable) {

                                            addClassyDiv(
                                                unit,
                                                'flex-child error not_playable_unit'
                                            ).innerHTML = msg.errors.not_playable_unit;

                                        }

                                        if (has_inventory && !init) {

                                            addClassyDiv(
                                                unit,
                                                'flex-child error unit_has_inventory_without_init'
                                            ).innerHTML = msg.errors.unit_has_inventory_without_init;

                                        }

                                    }
                                );
                            }
                        );
                });

            }

            if (report.slots && report.slots.unique_inits.length) {

                const uniqUnitInitsDiv = addClassyDiv(main, 'flex-child uniq-unit-inits');

                addClassyDiv(uniqUnitInitsDiv, 'flex-child heading')
                    .innerHTML = msg.headings.uniq_unit_inits;


                if (report.errors.has_unit_with_backpack_dup) {

                    addError(uniqUnitInitsDiv, msg.errors.has_unit_with_backpack_dup);

                }

                if (report.warnings.has_unit_without_personal_radio) {

                    addWarning(uniqUnitInitsDiv, msg.warnings.has_unit_without_personal_radio);
                
                }

                if (report.errors.unsupported_equipment_init) {

                    addError(
                        uniqUnitInitsDiv, 
                        msg.errors.unsupported_equipment_init +
                        ': ' +
                        report.errors.unsupported_equipment_init.join(', ')
                    );

                }


                report.slots.unique_inits.forEach(
                    (
                        {splitted_init, init, unsupported_equipment_init, has_no_radio, backpack_will_dup,
                            vanilla_equipment},
                        i
                    ) => {
                        
                        const initCode = addClassyCode(
                            uniqUnitInitsDiv,
                            unsupported_equipment_init ? 'flex-child init warning' : 'flex-child init'
                        );

                        initCode.id = 'n' + i;

                        initCode.innerHTML = unsupported_equipment_init ?
                            init + msg.warnings.unsupported_equipment_init : init;

                        if (has_no_radio) {

                            addClassyDiv(uniqUnitInitsDiv, 'flex-child warning')
                                .innerHTML = msg.warnings.has_no_personal_radio;

                        }

                        if (backpack_will_dup) {

                            addClassyDiv(uniqUnitInitsDiv, 'flex-child error')
                                .innerHTML = msg.errors.backpack_will_dup;

                        }

                        if (vanilla_equipment && vanilla_equipment.length) {

                            addClassyDiv(uniqUnitInitsDiv, 'flex-child error')
                                .innerHTML = `${msg.errors.vanilla_equipment}: ${vanilla_equipment}`;

                        }
                    }
                );
            }

        };

        window.addEventListener("load", () => {

            const hasLocalStorage = localStorage && localStorage.getItem;

            langSelect.addEventListener("change", () => {

                if (hasLocalStorage) {

                    localStorage.setItem('lang', langSelect.value)

                }

                renderWithLang(langSelect.value);

            });


            const initialLocalization = hasLocalStorage && localStorage.getItem('lang') || 'ru';

            renderWithLang(initialLocalization);

        });
    </script>
</body>
</html>
